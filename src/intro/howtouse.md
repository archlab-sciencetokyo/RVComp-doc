# How to Use RVComp on FPGA

This guide explains how to use RVComp after generating the bitstream.
The following tools and software are required.
Please refer to the [Installation Guide](install.md).
- Vivado
- TeraTerm (Windows)
- GTKTerm (Linux)


Please follow the configuration instructions below to set up TeraTerm (Windows) or GTKTerm (Linux).

## Using TeraTerm
1) Please launch TeraTerm and select File -> New connection.
2) Please select Serial and choose the COM port of the FPGA board (check with the lsusb command, etc.).
3) Please select Setup -> Terminal and configure as follows:
   - New-line Receive: LF
   - New-line Transmit: LF
4) Please select Setup -> Encoding and choose UTF-8 for Encoding receive.
5) Please select Setup -> Serial port and configure as follows:
   - Speed: your setting (default: 3200000)
   - Data: 8 bit
   - Parity: none
   - Stop: 1 bit
   - Flow control: none
6) Please load the bitstream to the FPGA (refer to "Loading to FPGA" at the bottom of this page).
7) "[     bootrom] Hello, world!" will be displayed in TeraTerm. If it is not displayed, refer to "Troubleshooting" at the bottom of this page and try to fix it.
8) In TeraTerm, please select File -> Send file and configure as follows:
    - Filename: Linux image to send (usually images/fw_payload.bin)
    - File reading method: Bulk read
    - Binary: Checked
    - Delay type: no delay
9) After the transmission is complete, Linux will start booting and a login prompt will be displayed.

## GTKTerm Setup (Linux)
For local FPGAs only, after completing [Makefile Setup](makesetup.md) (Vivado path configuration), you can launch GTKTerm, load the bitstream to the FPGA, and send the Linux image with `$ make config`.

If you are not using the Makefile, please use it as follows:
1) Please check the serial port to which the FPGA is connected. If only one is connected, it is often /dev/ttyUSB1.
2) Please launch GTKTerm with the following command. Replace \<device\> and \<your baudrate settings\> as appropriate.
```bash
$ gtkterm -p <device> -s <your baudrate settings>
```
3) Please load the bitstream to the FPGA (refer to "Loading to FPGA" at the bottom of this page).
4) "[     bootrom] Hello, world!" will be displayed in GTKTerm.
5) Please select File -> Send RAW file and choose the Linux image to send (usually images/fw_payload.bin).
6) After the transmission is complete, Linux will start booting and a login prompt will be displayed.

## Loading to FPGA

### Loading to Local FPGA
To load using the Vivado GUI, please launch Vivado, select Open Hardware Manager -> Open Target -> Auto Connect to connect to the FPGA, then select Program Device, choose the generated bitstream file, and load it.

If you have completed [Makefile Setup](makesetup.md) (Vivado path configuration), you can load the bitstream to the FPGA with the following command:
```bash
$ make load
```

### Loading to Remote FPGA
Please launch the Hardware Server of the corresponding Vivado version on the PC to which the FPGA board is connected.
To load using the Vivado GUI, please launch Vivado, select Open Hardware Manager -> Open Target -> Connect to Remote Server, enter the IP address and appropriate port number (usually no need to change), and connect. Then, please select Program Device, choose the generated bitstream file, and load it.

If you have completed [Makefile Setup](makesetup.md) (Vivado path, IP address, device serial number configuration), you can load the bitstream to the FPGA with the following command:
```bash
$ make remoteload
```

## Troubleshooting

### "[     bootrom] Hello, world!" is not displayed
- Bitstream is not loaded to the FPGA
- Serial port settings are incorrect (port, encoding, baud rate, etc.)
- Poor contact
    - Please try reconnecting the cable, replacing the cable, connecting to a different USB port, etc.
- Bitstream was generated without correctly generating the bootrom image
  - Please generate the bitstream with bootrom.128.hex already generated by make bootrom.
- All settings are correct but communication is not possible
  - If the baud rate is too high, communication may not be possible due to device or terminal software issues.
  - In the current RVComp design, the baud rate is matched by waiting $\lfloor\frac{Clock Frequency (Hz)}{Baudrate (bps)}\rfloor$ cycles. If the difference between the baud rate and the number of wait cycles is large, communication may not be possible. In that case, please adjust the Clock Frequency or Baudrate to reduce the difference from the truncated integer.

### Linux image was sent but Linux does not boot
- If garbled characters appear during transmission, it is likely a serial port issue. Handle it in the same way as when "[     bootrom] Hello, world!" is not displayed.
- Linux image was sent after some input was made in TeraTerm or GTKTerm
  - After startup, RVComp writes bytes received from the UART to DRAM for the number of bytes in the Linux binary and boots the secondary bootloader. Therefore, if there is any input after startup, the number of bytes in the Linux binary cannot be received correctly and Linux will not boot. If you have made any input in TeraTerm or GTKTerm, please load the bitstream to the FPGA again and send the Linux image again.
- Bitstream was generated without correctly generating the bootrom image
  - The bootrom program requires the number of bytes of the binary to be sent. If the number of bytes is not set correctly, Linux will not boot. Please check the BIN_SIZE argument of make bootrom in config.mk (usually the number of bytes in images/fw_payload.bin is set). Then please regenerate the bitstream.
  - The bootrom must be 8 KiB or less in size. If it exceeds 8 KiB, please modify the program or increase ROM_SIZE in the bootrom module.
- OpenSBI is displayed but does not proceed
  - The sent binary may not contain a Linux image. Refer to [Building Linux](build.md).
